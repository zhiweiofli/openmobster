<project>
	<parent>
	   <groupId>org.openmobster.core.mobileCloud.rimos</groupId>
	   <artifactId>mobileCloud-rimos</artifactId>
	   <version>2.0-snapshot</version>
	   <relativePath>../pom.xml</relativePath>
	</parent>
	
	<modelVersion>4.0.0</modelVersion>	
	<name>cloudManager</name>	
	<artifactId>cloudManager</artifactId>	
	<packaging>jar</packaging>
	
	<dependencies>
	    <dependency>
	    	<groupId>org.openmobster.core.mobileCloud.rimos</groupId>
	    	<artifactId>moblet-runtime</artifactId>
	    	<version>${project.version}</version>
	    </dependency>
	    <dependency>
	    	<groupId>org.openmobster.core.mobileCloud.rimos</groupId>
	    	<artifactId>native-framework</artifactId>
	    	<version>${project.version}</version>	  	
	    </dependency>
	</dependencies>
	
	<!-- build configuration -->
	<build>	        
		<plugins>		        
			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-antrun-plugin</artifactId>
				<executions>
				<execution>
					<phase>install</phase>
					<configuration>
						<tasks>
						        <property name="preverify_target" 
						        value="${basedir}/target/rapc"
						        />
						        <property name="preverify_src" 
						        value="${basedir}/target/cloudManager.jar"
						        />
						        <property name="rapc_src" 
						        value="${preverify_target}/cloudManager.jar"
						        />
						        <property name="rapc_config" 
						        value="${basedir}/src/main/config/rapc/cloudManager.rapc"
						        />						        						        
						        
						        <delete dir="${preverify_target}"/>
						        <delete file="${preverify_src}"/>
						        <mkdir dir="${preverify_target}"/>
						        
						        <delete dir="${basedir}/target/thirdparty"/>								        
								<unzip src="${settings.localRepository}/org/openmobster/core/mobileCloud/rimos/moblet-runtime/${project.version}/moblet-runtime.jar" 
								dest="${basedir}/target/thirdparty" overwrite="true"/>
								<unzip src="${settings.localRepository}/org/openmobster/core/mobileCloud/rimos/native-framework/${project.version}/native-framework-${project.version}.jar" 
								dest="${basedir}/target/thirdparty" overwrite="true"/>
						        					                                        						        
						        <jar file="${preverify_src}">
						        	<fileset dir="${basedir}/target/classes"/>							        	
						        	<fileset dir="${basedir}/target/thirdparty">
						        		<exclude name="**/META-INF/**"/>
						        	</fileset>							        							        							       
							    </jar>						        
						        						    						        						        
								<echo>Generating the BlackBerry OpenMobster Device Agent....</echo>
								
								<echo>Preverifying....</echo>
								<exec dir="${preverify_target}" executable="preverify">
									<arg line="-classpath ${basedir}/../../../net_rim_api.jar -d ${preverify_target} ${preverify_src}"/>
								</exec>
								
								
								<echo>Generating the Executable....</echo>
								<exec dir="${preverify_target}" executable="rapc">
					  				<arg line="import=${basedir}/../../../net_rim_api.jar codename=cloudManager ${rapc_config} ${rapc_src}"/>
								</exec>	
								
								<copy file="${preverify_target}/cloudManager.cod"
								todir="${settings.localRepository}/org/openmobster/core/mobileCloud/rimos/apps" overwrite="true"/>
								<copy todir="${settings.localRepository}/org/openmobster/core/mobileCloud/rimos/apps" 
							    overwrite="true">
							    		<fileset dir="${preverify_target}">
							    			<include name="**/*.debug"/>
							    		</fileset>
							    </copy>										
						</tasks>
					</configuration>
					<goals>
						<goal>run</goal>
					</goals>
				</execution>
				</executions>				
			</plugin>
		</plugins>
	</build>
	<profiles>
		<profile>
			<id>dev</id>
			<build>	        
				<plugins>		        
					<plugin>
						<groupId>org.apache.maven.plugins</groupId>
						<artifactId>maven-antrun-plugin</artifactId>
						<executions>
						<execution>
							<phase>install</phase>
							<configuration>
								<tasks>
								        <property name="preverify_target" 
								        value="${basedir}/target/rapc"
								        />
								        <property name="preverify_src" 
								        value="${basedir}/target/cloudManager.jar"
								        />
								        <property name="rapc_src" 
								        value="${preverify_target}/cloudManager.jar"
								        />
								        <property name="rapc_config" 
								        value="${basedir}/src/main/config/rapc/cloudManager.rapc"
								        />						        						        
								        
								        <delete dir="${preverify_target}"/>
								        <delete file="${preverify_src}"/>
								        <mkdir dir="${preverify_target}"/>
								        
								        <delete dir="${basedir}/target/thirdparty"/>								        
										<unzip src="${settings.localRepository}/org/openmobster/core/mobileCloud/rimos/moblet-runtime/${project.version}/moblet-runtime.jar" 
										dest="${basedir}/target/thirdparty" overwrite="true"/>
										<unzip src="${settings.localRepository}/org/openmobster/core/mobileCloud/rimos/native-framework/${project.version}/native-framework-${project.version}.jar" 
										dest="${basedir}/target/thirdparty" overwrite="true"/>
								  
								        	                                        						        
								        <jar file="${preverify_src}">
								        	<fileset dir="${basedir}/target/classes"/>							        	
								        	<fileset dir="${basedir}/target/thirdparty">
								        		<exclude name="**/META-INF/**"/>
								        	</fileset>	
								        	<fileset dir="${basedir}/src/main/config/dev">								   
								        	</fileset>						        							        							       
									    </jar>						        
								        						    						        						        
										<echo>Generating the BlackBerry OpenMobster Device Agent....</echo>
										
										<echo>Preverifying....</echo>
										<exec dir="${preverify_target}" executable="preverify">
											<arg line="-classpath ${basedir}/../../../net_rim_api.jar -d ${preverify_target} ${preverify_src}"/>
										</exec>
										
										
										<echo>Generating the Executable....</echo>
										<exec dir="${preverify_target}" executable="rapc">
							  				<arg line="import=${basedir}/../../../net_rim_api.jar codename=cloudManager ${rapc_config} ${rapc_src}"/>
										</exec>	
										
										<copy file="${preverify_target}/cloudManager.cod"
										todir="${settings.localRepository}/org/openmobster/core/mobileCloud/rimos/apps" overwrite="true"/>
										<copy todir="${settings.localRepository}/org/openmobster/core/mobileCloud/rimos/apps" 
									    overwrite="true">
									    		<fileset dir="${preverify_target}">
									    			<include name="**/*.debug"/>
									    		</fileset>
									    </copy>										
								</tasks>
							</configuration>
							<goals>
								<goal>run</goal>
							</goals>
						</execution>
						</executions>				
					</plugin>
				</plugins>
			</build>
		</profile>
	</profiles>
</project>